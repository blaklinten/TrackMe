#!/bin/bash

sum()
{
	ACTIVITY="$1"
    for LINE in $(sed -n '0~3p' "$ACTIVITY"); do
        if [[ ! "$LINE" == "Duration:" ]]; then
            let "HOURS = $HOURS + $(echo "$LINE" | sed -n -e 's/^\(.*\):\(.*\):\(.*\)/\1/p')"
            let "MINUTES = $MINUTES + $(echo "$LINE" | sed -n -e 's/^\(.*\):\(.*\):\(.*\)/\2/p')"
            let "SEC = $SEC + $(echo "$LINE" | sed -n -e 's/^\(.*\):\(.*\):\(.*\)/\3/p')"
        fi
    done

	let "HOURS = $HOURS + ($MINUTES + $SEC / 60) / 60"
	let "MINUTES = ($MINUTES + $SEC / 60) % 60"
	let "SEC = $SEC % 60"

}

sumActivity()
{
	ACTIVITY="$1"

	HOURS=0
	MINUTES=0
	SEC=0

	sum "$ACTIVITY"

	echo "Total time = $HOURS:$MINUTES:$SEC" | dmenu
}

sumProject()
{
	PROJECT="$1"

	HOURS=0
	MINUTES=0
	SEC=0

	for ACTIVITY in $(ls "$PROJECT"); do
		sum "$PROJECT/$ACTIVITY"
	done

	echo "Total time = $HOURS:$MINUTES:$SEC" | dmenu
}

summarize()
{
	PROJECT="$1"

	CHOICE=$(parseSpaces $(echo -e "Choose one activity \nall\nor\nquit\n$(for ACTIVITY in $(ls $PROJECTS/$PROJECT); do parseUnderscores "$ACTIVITY"; done)" | dmenu -i))

	case $CHOICE in 
    	"quit")
        	exit
    	;;
    	"all")
        	sumProject "$PROJECTS/$PROJECT"
        	exit
    	;;
    	*)
        	pushd "$PROJECTS/$PROJECT" > /dev/null
        	for ACTIVITY in *; do
            	if [[ "$CHOICE" == "$ACTIVITY" ]]; then
                	sumEntries "$PROJECTS/$PROJECT/$CHOICE"
                	popd > /dev/null
                	exit
            	fi
        	done
        	echo "Activity \"$CHOICE\" does not exist, try again or exit (q)." | dmenu
        	summarize "$PROJECT"
        	;;
	esac
}
